<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BOT استیکر گلیچ</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: #6E0B05;
            min-height: 100vh;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        
        .preview-section {
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
            min-height: 500px;
            width: 100%;
            max-width: 800px;
        }
        
        .upload-area {
            width: 100%;
            max-width: 800px;
            border: 2px dashed rgba(255, 255, 255, 0.3);
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 300px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
        }
        
        .upload-area:hover {
            border-color: rgba(255, 255, 255, 0.5);
            background: rgba(255, 255, 255, 0.15);
            transform: translateY(-3px);
        }
        
        .upload-icon {
            font-size: 2.5rem;
            color: rgba(255, 255, 255, 0.9);
            margin-bottom: 10px;
        }
        
        .upload-btn {
            display: inline-block;
            padding: 10px 25px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            border-radius: 50px;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
        }
        
        .upload-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
        }
        
        .canvas-container {
            width: 100%;
            max-width: 800px;
            height: 400px;
            display: flex;
            justify-content: center;
            align-items: center;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.18);
            overflow: hidden;
            position: relative;
            display: none;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }
        
        canvas {
            max-width: 100%;
            max-height: 100%;
            background-color: rgba(248, 248, 248, 0.2);
            background-image: 
                linear-gradient(45deg, rgba(224, 224, 224, 0.2) 25%, transparent 25%, transparent 75%, rgba(224, 224, 224, 0.2) 75%),
                linear-gradient(45deg, rgba(224, 224, 224, 0.2) 25%, transparent 25%, transparent 75%, rgba(224, 224, 224, 0.2) 75%);
            background-size: 20px 20px;
            background-position: 0 0, 10px 10px;
        }
        
        .presets-section {
            padding: 15px 0 0;
            text-align: center;
            display: none;
            width: 100%;
        }
        
        .preset-buttons {
            display: flex;
            justify-content: center;
            gap: 10px;
            flex-wrap: nowrap;
            margin-bottom: 15px;
        }
        
        .action-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
            flex-wrap: wrap;
            margin-top: 15px;
        }
        
        .btn {
            padding: 8px 16px;
            font-size: 0.9rem;
            font-weight: 600;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.2);
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            white-space: nowrap;
        }
        
        .btn-preset {
            background: rgba(255, 255, 255, 0.15);
            color: white;
            width: 85px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .btn-preset:hover {
            background: rgba(255, 255, 255, 0.25);
        }
        
        .btn-primary {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            padding: 12px 30px;
            border-radius: 50px;
            font-size: 1rem;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .btn-new {
            background: rgba(255, 215, 0, 0.2);
            color: white;
            padding: 12px 30px;
            border-radius: 50px;
            font-size: 1rem;
            border: 1px solid rgba(255, 215, 0, 0.3);
        }
        
        .btn-new:hover {
            background: rgba(255, 215, 0, 0.3);
        }
        
        .btn-primary:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }
        
        .btn:active {
            transform: translateY(1px);
        }
        
        .loading {
            display: none;
            align-items: center;
            gap: 15px;
            color: rgba(255, 255, 255, 0.9);
            font-size: 1.1rem;
            justify-content: center;
            padding: 15px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            margin-top: 15px;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.18);
        }
        
        .spinner {
            width: 24px;
            height: 24px;
            border: 3px solid rgba(255, 255, 255, 0.2);
            border-top: 3px solid rgba(255, 255, 255, 0.9);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .file-info {
            display: flex;
            flex-direction: column;
            align-items: center;
            color: rgba(255, 255, 255, 0.9);
            font-size: 0.9rem;
            margin-top: 10px;
        }
        
        .pulse {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            from { transform: scale(1); }
            50% { transform: scale(1.05); }
            to { transform: scale(1); }
        }
        
        /* طراحی واکنش‌گرا */
        @media (max-width: 900px) {
            .canvas-container {
                height: 350px;
            }
        }
        
        @media (max-width: 600px) {
            .canvas-container {
                height: 300px;
            }
            
            .action-buttons {
                flex-direction: column;
                align-items: center;
            }
            
            .btn-primary, .btn-new {
                width: 100%;
                max-width: 250px;
                justify-content: center;
            }
            
            .preview-section {
                padding: 15px;
            }
            
            .upload-area {
                padding: 15px;
            }
            
            .preset-buttons {
                flex-wrap: nowrap;
            }
            
            .btn-preset {
                width: 80px;
                font-size: 0.85rem;
                padding: 7px 12px;
            }
        }
    </style>
</head>
<body>
    <div class="preview-section">
        <div class="upload-area" id="uploadArea">
            <div class="upload-icon">
                <i class="fas fa-cloud-upload-alt"></i>
            </div>
            <button class="upload-btn pulse">
                انتخاب تصویر
            </button>
            <input type="file" id="imageUpload" accept="image/*" style="display: none;">
        </div>
        
        <div class="canvas-container" id="canvasContainer">
            <canvas id="canvas"></canvas>
        </div>
        
        <div id="loading" class="loading">
            <div class="spinner"></div>
            <span>در حال پردازش تصویر...</span>
        </div>
        
        <div class="presets-section" id="presetsSection">
            <div class="preset-buttons">
                <button id="preset1" class="btn btn-preset">
                    گلیچ B
                </button>
                <button id="preset2" class="btn btn-preset">
                    گلیچ A
                </button>
            </div>
            
            <div class="action-buttons">
                <button id="download" class="btn btn-primary">
                    دانلود استیکر
                </button>
                <button id="newImageBtn" class="btn btn-new" style="display: none;">
                    انتخاب عکس دیگر
                </button>
            </div>
        </div>
    </div>

    <script>
        // عناصر DOM
        const imageUpload = document.getElementById('imageUpload');
        const uploadArea = document.getElementById('uploadArea');
        const downloadBtn = document.getElementById('download');
        const loading = document.getElementById('loading');
        const canvas = document.getElementById('canvas');
        const canvasContainer = document.getElementById('canvasContainer');
        const presetsSection = document.getElementById('presetsSection');
        const newImageBtn = document.getElementById('newImageBtn');
        const ctx = canvas.getContext('2d');
        const preset1Btn = document.getElementById('preset1');
        const preset2Btn = document.getElementById('preset2');
        
        // متغیرهای global
        let originalImage = null;
        let imageData = null;
        let isProcessing = false;
        let currentPreset = null;
        
        // تعریف حالت‌های پیش‌فرض
        const presets = {
            preset1: { dotSize: 1, dotsWidth: 200, dotsHeight: 52 },
            preset2: { dotSize: 2, dotsWidth: 200, dotsHeight: 48 }
        };
        
        // رویدادهای آپلود
        uploadArea.addEventListener('click', function() {
            imageUpload.click();
        });
        
        uploadArea.addEventListener('dragover', function(e) {
            e.preventDefault();
            uploadArea.style.borderColor = 'rgba(255, 255, 255, 0.5)';
            uploadArea.style.backgroundColor = 'rgba(255, 255, 255, 0.15)';
        });
        
        uploadArea.addEventListener('dragleave', function() {
            uploadArea.style.borderColor = 'rgba(255, 255, 255, 0.3)';
            uploadArea.style.backgroundColor = 'rgba(255, 255, 255, 0.1)';
        });
        
        uploadArea.addEventListener('drop', function(e) {
            e.preventDefault();
            uploadArea.style.borderColor = 'rgba(255, 255, 255, 0.3)';
            uploadArea.style.backgroundColor = 'rgba(255, 255, 255, 0.1)';
            
            if (e.dataTransfer.files && e.dataTransfer.files[0]) {
                imageUpload.files = e.dataTransfer.files;
                handleImageUpload(e.dataTransfer.files[0]);
            }
        });
        
        imageUpload.addEventListener('change', function(e) {
            if (e.target.files && e.target.files[0]) {
                handleImageUpload(e.target.files[0]);
            }
        });
        
        // توابع حالت‌های پیش‌فرض
        function applyPreset1() {
            currentPreset = 'preset1';
            applyFilter(presets.preset1);
            
            // برجسته کردن دکمه فعال
            preset1Btn.style.transform = 'translateY(-2px)';
            preset1Btn.style.boxShadow = '0 5px 15px rgba(0, 0, 0, 0.3)';
            preset2Btn.style.transform = 'none';
            preset2Btn.style.boxShadow = '0 3px 10px rgba(0, 0, 0, 0.2)';
        }
        
        function applyPreset2() {
            currentPreset = 'preset2';
            applyFilter(presets.preset2);
            
            // برجسته کردن دکمه فعال
            preset2Btn.style.transform = 'translateY(-2px)';
            preset2Btn.style.boxShadow = '0 5px 15px rgba(0, 0, 0, 0.3)';
            preset1Btn.style.transform = 'none';
            preset1Btn.style.boxShadow = '0 3px 10px rgba(0, 0, 0, 0.2)';
        }
        
        preset1Btn.addEventListener('click', applyPreset1);
        preset2Btn.addEventListener('click', applyPreset2);
        
        function handleImageUpload(file) {
            const reader = new FileReader();
            
            reader.onload = function(event) {
                originalImage = new Image();
                originalImage.onload = function() {
                    // مخفی کردن ناحیه آپلود
                    uploadArea.style.display = 'none';
                    
                    // نمایش ناحیه کانوا و تنظیمات
                    canvasContainer.style.display = 'flex';
                    presetsSection.style.display = 'block';
                    newImageBtn.style.display = 'block'; // نمایش دکمه انتخاب عکس بعدی
                    
                    // تنظیم اندازه کانوا با حفظ نسبت تصویر
                    const container = document.querySelector('.canvas-container');
                    const maxWidth = container.clientWidth - 40;
                    const maxHeight = container.clientHeight - 40;
                    
                    let width = originalImage.width;
                    let height = originalImage.height;
                    
                    if (width > maxWidth) {
                        const ratio = maxWidth / width;
                        width = maxWidth;
                        height = height * ratio;
                    }
                    
                    if (height > maxHeight) {
                        const ratio = maxHeight / height;
                        height = maxHeight;
                        width = width * ratio;
                    }
                    
                    canvas.width = width;
                    canvas.height = height;
                    
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    ctx.drawImage(originalImage, 0, 0, width, height);
                    imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                    
                    // اعمال حالت پیش‌فرض ۲ (گلیچ A) به صورت خودکار
                    applyPreset2();
                };
                originalImage.src = event.target.result;
            };
            
            reader.readAsDataURL(file);
        }
        
        // اعمال فیلتر
        function applyFilter(preset) {
            if (!originalImage || isProcessing) return;
            
            isProcessing = true;
            loading.style.display = 'flex';
            
            // استفاده از requestAnimationFrame برای عملکرد بهتر
            requestAnimationFrame(() => {
                try {
                    const size = preset.dotSize;
                    const dotsW = preset.dotsWidth;
                    const dotsH = preset.dotsHeight;
                    
                    // کانوا را پاک می‌کنیم - پس‌زمینه همیشه شفاف است
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    
                    // محاسبه فاصله بین نقاط بر اساس تعداد مربع‌های مورد نظر
                    const spaceX = canvas.width / dotsW;
                    const spaceY = canvas.height / dotsH;
                    
                    // نقاط را رسم می‌کنیم (به صورت مربع)
                    for (let y = 0; y < canvas.height; y += spaceY) {
                        for (let x = 0; x < canvas.width; x += spaceX) {
                            // محاسبه موقعیت دقیق نقطه
                            const pixelX = Math.min(Math.floor(x), canvas.width - 1);
                            const pixelY = Math.min(Math.floor(y), canvas.height - 1);
                            
                            const pixelIndex = (pixelY * canvas.width + pixelX) * 4;
                            const r = imageData.data[pixelIndex];
                            const g = imageData.data[pixelIndex + 1];
                            const b = imageData.data[pixelIndex + 2];
                            const a = imageData.data[pixelIndex + 3] / 255;
                            
                            ctx.fillStyle = `rgba(${r}, ${g}, ${b}, ${a})`;
                            
                            // رسم مربع به جای دایره
                            const halfSize = size / 2;
                            ctx.fillRect(x - halfSize, y - halfSize, size, size);
                        }
                    }
                } catch (error) {
                    console.error('خطا در اعمال فیلتر:', error);
                } finally {
                    isProcessing = false;
                    loading.style.display = 'none';
                }
            });
        }
        
        // تبدیل canvas به WebP با فشرده‌سازی 20%
        function canvasToWebP(quality = 0.8) {
            return new Promise((resolve) => {
                // ایجاد یک canvas موقت برای پردازش
                const tempCanvas = document.createElement('canvas');
                tempCanvas.width = canvas.width;
                tempCanvas.height = canvas.height;
                const tempCtx = tempCanvas.getContext('2d');
                
                // کپی کردن محتوای canvas اصلی
                tempCtx.drawImage(canvas, 0, 0);
                
                // تبدیل به WebP با کیفیت 80% (فشرده‌سازی 20%)
                tempCanvas.toBlob(resolve, 'image/webp', quality);
            });
        }
        
        // بازگشت به حالت اولیه
        function resetToInitialState() {
            // پاک کردن canvas
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // مخفی کردن بخش‌های پردازش
            canvasContainer.style.display = 'none';
            presetsSection.style.display = 'none';
            newImageBtn.style.display = 'none';
            
            // نمایش دادن ناحیه آپلود
            uploadArea.style.display = 'flex';
            
            // ریست کردن متغیرها
            originalImage = null;
            imageData = null;
            currentPreset = null;
            
            // پاک کردن مقدار input file
            imageUpload.value = '';
        }
        
        // رویداد کلیک برای دکمه انتخاب عکس جدید
        newImageBtn.addEventListener('click', resetToInitialState);
        
        // دانلود تصویر با فرمت WebP
        downloadBtn.addEventListener('click', async function() {
            if (!originalImage) {
                alert('لطفاً ابتدا یک تصویر انتخاب کنید');
                return;
            }
            
            if (!currentPreset) {
                alert('لطفاً ابتدا یک حالت پیش‌فرض انتخاب کنید');
                return;
            }
            
            try {
                loading.style.display = 'flex';
                downloadBtn.disabled = true;
                
                // تبدیل به WebP با کیفیت 80% (فشرده‌سازی 20%)
                const blob = await canvasToWebP(0.8);
                
                // ایجاد لینک دانلود
                const link = document.createElement('a');
                const preset = presets[currentPreset];
                
                // نام فایل با توجه به حالت انتخاب شده
                link.download = `نقاشی_نقطه‌ای_حالت_${currentPreset === 'preset1' ? 'B' : 'A'}.webp`;
                link.href = URL.createObjectURL(blob);
                
                // دانلود بدون نمایش پیام
                link.click();
                
            } catch (error) {
                console.error('خطا در تبدیل به WebP:', error);
                alert('خطایی در پردازش تصویر رخ داده است. لطفاً دوباره تلاش کنید.');
            } finally {
                loading.style.display = 'none';
                downloadBtn.disabled = false;
            }
        });
    </script>
</body>
</html>
